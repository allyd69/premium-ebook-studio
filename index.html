<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Premium Ebook Studio | Cinematic Covers & Professional Templates</title>
  <meta name="description" content="Create stunning ebooks with AI-generated cinematic covers and premium formatting templates">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body,#root { height: 100%; }
    body {
      font-family: 'Cormorant Garamond', Georgia, serif;
      background: linear-gradient(180deg,#0A0A0F 0%, #151520 50%, #0D0D12 100%);
      color: #E8E8E8;
      -webkit-font-smoothing:antialiased;
    }
    ::-webkit-scrollbar { width: 8px; height:8px; }
    ::-webkit-scrollbar-track { background: #0D0D0D; }
    ::-webkit-scrollbar-thumb { background: #D4AF37; border-radius: 6px; }

    /* small helpers */
    .hidden { display:none; }
    .card { background: linear-gradient(145deg, rgba(20,20,28,0.9), rgba(15,15,22,0.95)); border-radius: 10px; border:1px solid rgba(212,175,55,0.15); padding: 16px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { 0%{ transform: rotate(0);} 100%{ transform: rotate(360deg);} }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    /*******************************
     * Helper utilities & styles
     *******************************/
    const fileIcons = {
      txt: "üìÑ",
      doc: "üìù",
      docx: "üìù",
      rtf: "üìò",
      md: "üìú",
      default: "üìë"
    };

    const getFileExtension = (name) => {
      const parts = name.split('.');
      return parts.length > 1 ? parts.pop().toLowerCase() : '';
    };

    const getStats = (text = '') => {
      const words = text.trim() ? text.trim().split(/\s+/).filter(Boolean).length : 0;
      return { words, characters: text.length, readingTime: Math.max(1, Math.ceil(words / 200)) };
    };

    const cleanManuscript = (text = '') => {
      return text
        .replace(/\r\n/g, '\n')
        .replace(/\n{3,}/g, '\n\n')
        .replace(/ {2,}/g, ' ')
        .replace(/\t+/g, ' ')
        .trim();
    };

    const detectChaptersFromText = (text = '') => {
      const lines = text.split(/\r?\n/);
      const chapters = [];
      let current = null;
      let buffer = [];

      const flush = () => {
        if (!current) return;
        const content = buffer.join('\n').trim();
        const words = content.split(/\s+/).filter(Boolean).length;
        chapters.push({ id: chapters.length + 1, title: current, wordCount: words, content });
        buffer = [];
      };

      for (let i=0;i<lines.length;i++){
        const line = lines[i].trim();
        const isHeading = /^(chapter|part)\b\s*[:\-]?\s*\d*/i.test(line) || /^#{1,3}\s+/.test(line);
        if (isHeading) {
          if (current) flush();
          const title = line.replace(/^#{1,3}\s+/, '').replace(/^(chapter|part)\b[:\s]*/i, '').trim() || `Chapter ${chapters.length+1}`;
          current = title || `Chapter ${chapters.length+1}`;
        } else {
          if (!current) current = 'Beginning';
          buffer.push(line);
        }
      }
      if (current) flush();
      if (chapters.length === 0) {
        const words = text.split(/\s+/).filter(Boolean).length;
        chapters.push({ id: 1, title: 'Full Document', wordCount: words, content: text.trim() });
      }
      return chapters;
    };

    const toMarkdown = (text = '') => {
      let md = text.replace(/^(Chapter|CHAPTER|Part|PART)\b\s*([0-9IVXLC]*)\s*[:\-]?\s*(.*)$/gmi, (m,p1,p2,p3) => {
        const heading = (p2 || p3) ? `# ${p1}${p2 ? ' ' + p2 : ''}${p3 ? ': ' + p3 : ''}` : `# ${p1}`;
        return heading;
      });
      md = md.replace(/\r\n/g, '\n').replace(/\n{3,}/g, '\n\n').trim();
      return md;
    };

    const generateTOCFromChapters = (chapters=[]) => {
      if (!chapters || chapters.length === 0) return '';
      return chapters.map((c,i)=> `${i+1}. ${c.title} (${c.wordCount.toLocaleString()} words)`).join('\n');
    };

    // Small style objects to reuse
    const primaryBtnStyle = { padding: '8px 12px', borderRadius: 8, background: 'linear-gradient(135deg,#D4AF37 0%,#AA8C2C 100%)', border: 'none', color: '#111', cursor: 'pointer', fontWeight: 700, fontSize: 12 };
    const secondaryBtnStyle = { padding: '8px 12px', borderRadius: 8, background: 'transparent', border: '1px solid rgba(212,175,55,0.12)', color: '#E8E8E8', cursor: 'pointer', fontSize: 12 };
    const ctaBtnStyle = { padding: '8px 12px', borderRadius: 8, background: '#8B6F11', color: '#fff', border: 'none', cursor: 'pointer', fontWeight: 700, fontSize: 12 };

    /*******************************
     * Optional AI call helper (browser)
     * - Requires API key to be provided in the UI.
     * - You can replace with your server-side proxy.
     *******************************/
    const aiEditRequest = async ({ inputText, mode = 'rewrite', apiKey, model = 'gpt-4o-mini' }) => {
      if (!apiKey) throw new Error('No API key provided for AI editing.');
      const systemPrompts = {
        rewrite: 'You are a professional editor. Rewrite the text to improve clarity, grammar, flow and structure. Preserve meaning.',
        grammar: 'You are a copy editor. Fix grammar, punctuation, and spelling only; do not change content meaning.',
        shorten: 'You are an editor. Shorten this content by 30% while preserving essential meaning and tone.',
        expand: 'You are an editor. Expand and clarify this content, adding helpful detail where appropriate.',
        suggestTocs: 'Generate a JSON array of chapter titles and short descriptions derived from the manuscript.'
      };
      const messages = [
        { role: 'system', content: systemPrompts[mode] || systemPrompts.rewrite },
        { role: 'user', content: `Please edit the following manuscript content. Return only the edited text.\n\n${inputText}` }
      ];
      const resp = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model,
          messages,
          temperature: 0.3,
          max_tokens: 2500
        })
      });
      if (!resp.ok) {
        const errText = await resp.text();
        throw new Error(`AI API error: ${resp.status} ${errText}`);
      }
      const data = await resp.json();
      const content = data?.choices?.[0]?.message?.content;
      if (!content) throw new Error('No content returned from AI');
      return content.trim();
    };

    /*******************************
     * Main component
     *******************************/
    function PremiumEbookStudio(){
      // UI state
      const [activeTab, setActiveTab] = useState('cover');

      // Cover tab state
      const [coverPrompt, setCoverPrompt] = useState('');
      const [generatedCover, setGeneratedCover] = useState(null);
      const [generatedImages, setGeneratedImages] = useState([]);
      const [coverStyle, setCoverStyle] = useState('cinematic');
      const [uploadedCoverImage, setUploadedCoverImage] = useState(null);
      const [imageSource, setImageSource] = useState('none');
      const [imageOpacity, setImageOpacity] = useState(100);
      const [overlayOpacity, setOverlayOpacity] = useState(50);
      const [isGenerating, setIsGenerating] = useState(false);

      // Manuscript & Upload state
      const [dragActive, setDragActive] = useState(false);
      const [uploadedFile, setUploadedFile] = useState(null);
      const [uploadedDoc, setUploadedDoc] = useState(null);
      const [manuscriptContent, setManuscriptContent] = useState('');
      const [documentContent, setDocumentContent] = useState('');
      const [chapters, setChapters] = useState([]);
      const [manuscriptPreviewOpen, setManuscriptPreviewOpen] = useState(false);
      const [aiApiKey, setAiApiKey] = useState('');
      const [isExporting, setIsExporting] = useState(false);
      const [notification, setNotification] = useState(null);

      // Book metadata
      const [ebookTitle, setEbookTitle] = useState('');
      const [ebookSubtitle, setEbookSubtitle] = useState('');
      const [ebookTagline, setEbookTagline] = useState('');
      const [ebookAuthor, setEbookAuthor] = useState('');
      const [ebookImprint, setEbookImprint] = useState('');
      const [fontSize, setFontSize] = useState('12');
      const [lineSpacing, setLineSpacing] = useState('1.6');
      const [pageSize, setPageSize] = useState('6x9');
      const [showPageNumbers, setShowPageNumbers] = useState(true);
      const [showHeader, setShowHeader] = useState(true);
      const [previewMode, setPreviewMode] = useState('fullbook');

      // Refs
      const fileInputRef = useRef(null);
      const imageInputRef = useRef(null);

      // Templates & cover styles
      const templates = [
        { id: 'luxury', name: 'Luxury Edition', desc: 'Gold accents, elegant serif', color: '#D4AF37', gradient: 'linear-gradient(135deg, #D4AF37 0%, #F4E5B2 50%, #D4AF37 100%)' },
        { id: 'modern', name: 'Modern Minimal', desc: 'Clean, contemporary', color: '#1a1a2e', gradient: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)' },
        { id: 'creative', name: 'Creative Bold', desc: 'Vibrant, artistic', color: '#FF6B6B', gradient: 'linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%)' },
        { id: 'professional', name: 'Professional', desc: 'Corporate style', color: '#2C3E50', gradient: 'linear-gradient(135deg, #2C3E50 0%, #34495E 100%)' },
        { id: 'romantic', name: 'Romance', desc: 'Soft, elegant', color: '#E8B4BC', gradient: 'linear-gradient(135deg, #E8B4BC 0%, #F5D0D5 100%)' },
        { id: 'thriller', name: 'Thriller Dark', desc: 'Moody, suspenseful', color: '#0D0D0D', gradient: 'linear-gradient(135deg, #0D0D0D 0%, #2d2d2d 100%)' },
      ];
      const coverStyles = [
        { id: 'cinematic', name: 'Cinematic', icon: 'üé¨' },
        { id: 'photorealistic', name: 'Photorealistic', icon: 'üì∑' },
        { id: 'artistic', name: 'Artistic', icon: 'üé®' },
        { id: 'minimalist', name: 'Minimalist', icon: '‚óªÔ∏è' },
        { id: 'vintage', name: 'Vintage', icon: 'üìú' },
        { id: 'fantasy', name: 'Fantasy', icon: '‚ú®' },
      ];

      const presets = [
        { id: 'print', name: 'Print', pageSize: '6x9', fontSize: '12', lineSpacing: '1.6' },
        { id: 'kindle', name: 'Kindle', pageSize: '5.5x8.5', fontSize: '11', lineSpacing: '1.5' },
        { id: 'pocket', name: 'Pocket', pageSize: '5x8', fontSize: '10', lineSpacing: '1.4' },
      ];

      const sampleContent = `Chapter 1: The Beginning

The morning light filtered through the ancient windows, casting long shadows across the weathered floorboards. She stood there, breath held, knowing that the next few moments would change everything. The letter trembled in her hands as she read the words that would alter the course of her life forever.

Years of searching had led to this single moment. A lifetime of questions waiting to be answered. The room fell silent as she turned the page, her heart racing with anticipation.

"I never thought this day would come," she whispered to the empty room. But the room wasn't empty ‚Äî it was full of memories, of ghosts, of possibilities that stretched out before her like an endless horizon.

She folded the letter carefully and placed it close to her heart. It was time to begin the journey she had always feared ‚Äî the one that would lead her home.

Chapter 2: The Journey

The road stretched endlessly before her, winding through valleys and over mountains that seemed to touch the sky. Each step brought her closer to the truth she had been seeking, yet further from the life she had known.

The villagers she met along the way spoke of legends and prophecies, of a time when the world was different. They shared their bread and their stories, and she carried both with her as she continued on.

By the time she reached the ancient forest, the seasons had changed twice. The trees here were older than memory, their roots reaching deep into the earth where secrets lay buried. This was where her journey would either end or truly begin.`;

      // Notifications
      const showNotification = (message, type='success') => {
        setNotification({ message, type });
        setTimeout(()=> setNotification(null), 4200);
      };

      // Local image loader
      const loadImageAsDataUrl = async (url) => {
        return new Promise((resolve,reject)=>{
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = function(){
            const canvas = document.createElement('canvas');
            canvas.width = this.naturalWidth;
            canvas.height = this.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(this,0,0);
            resolve(canvas.toDataURL('image/jpeg',0.92));
          };
          img.onerror = reject;
          img.src = url;
        });
      };

      const getCurrentCoverImage = () => {
        if (imageSource === 'upload' && uploadedCoverImage) return uploadedCoverImage.url;
        if (imageSource === 'ai' && generatedCover) return generatedCover.url;
        return null;
      };

      // File upload handler - reads file as text (basic)
      const handleFileUpload = useCallback((e) => {
        const file = e?.target?.files ? e.target.files[0] : e;
        if (!file) return;
        setUploadedFile(file);
        setUploadedDoc({ name: file.name, size: (file.size/1024).toFixed(2) + ' KB', type: file.type });
        const reader = new FileReader();
        reader.onload = (ev) => {
          const content = String(ev.target.result || '');
          const cleaned = content;
          setDocumentContent(cleaned);
          setManuscriptContent(cleaned);
          const detected = detectChaptersFromText(cleaned);
          setChapters(detected);
          showNotification(`‚úì Uploaded: ${file.name} ‚Äî ${detected.length} section(s)`);
        };
        // Prefer readAsText for document types
        reader.readAsText(file);
      }, []);

      // image upload for cover
      const handleImageUpload = useCallback((e) => {
        const file = e?.target?.files ? e.target.files[0] : e;
        if (!file) return;
        if (!file.type.startsWith('image/')) {
          showNotification('Please upload an image file', 'error'); return;
        }
        const reader = new FileReader();
        reader.onload = (ev) => {
          setUploadedCoverImage({ url: ev.target.result, name: file.name, type: file.type, size: (file.size / 1024).toFixed(2) + ' KB' });
          setImageSource('upload');
          showNotification(`‚úì Image uploaded: ${file.name}`);
        };
        reader.readAsDataURL(file);
      }, []);

      // Simple fake AI generator (placeholder) ‚Äî uses picsum seed for demo
      const generateCover = async () => {
        if (!coverPrompt.trim()) { showNotification('Please enter a cover description', 'error'); return; }
        setIsGenerating(true);
        try {
          await new Promise(r=>setTimeout(r,1500));
          const seed = coverPrompt.split('').reduce((a,c)=>a+ c.charCodeAt(0),0);
          const url = `https://picsum.photos/seed/${seed}/600/900`;
          const result = { url, prompt: coverPrompt, style: coverStyle, timestamp: new Date().toISOString() };
          setGeneratedCover(result);
          setGeneratedImages(prev=>[...prev, result]);
          setImageSource('ai');
          showNotification('‚úì AI Cover generated (demo)');
        } catch (err) {
          console.error(err);
          showNotification('Error generating cover', 'error');
        } finally { setIsGenerating(false); }
      };

      // Export PDF (using jsPDF) - simplified, adapted from original
      const exportPDF = async () => {
        setIsExporting(true);
        showNotification('üìÑ Creating PDF...');
        try {
          const { jsPDF } = window.jspdf;
          const pageSizes = { '6x9': [432,648], '5.5x8.5':[396,612], '5x8':[360,576], 'a5':[420,595], 'letter':[612,792] };
          const [pageWidth, pageHeight] = pageSizes[pageSize] || pageSizes['6x9'];
          const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [pageWidth, pageHeight] });
          const margin = 50;
          const contentWidth = pageWidth - margin*2;
          const lineHeight = parseInt(fontSize) * parseFloat(lineSpacing);

          const title = ebookTitle || 'Untitled Book';
          const subtitle = ebookSubtitle || '';
          const author = ebookAuthor || 'Unknown Author';
          const tagline = ebookTagline || '';
          const imprint = ebookImprint || author;
          const currentYear = new Date().getFullYear();

          // COVER
          const coverUrl = getCurrentCoverImage();
          if (coverUrl) {
            const coverDataUrl = coverUrl.startsWith('data:') ? coverUrl : await loadImageAsDataUrl(coverUrl);
            pdf.addImage(coverDataUrl, 'JPEG', 0, 0, pageWidth, pageHeight);
          } else {
            pdf.setFillColor(26,26,46);
            pdf.rect(0,0,pageWidth,pageHeight,'F');
          }

          pdf.setFillColor(212,175,55);
          pdf.rect(0,0,pageWidth,8,'F');
          pdf.setTextColor(255,255,255);
          pdf.setFontSize(28);
          pdf.setFont('helvetica','bold');
          const titleLines = pdf.splitTextToSize(title, contentWidth);
          pdf.text(titleLines, pageWidth/2, pageHeight*0.4, { align: 'center' });
          if (subtitle) { pdf.setFontSize(18); pdf.text(subtitle, pageWidth/2, pageHeight*0.45, { align:'center' }); }
          if (tagline) { pdf.setFontSize(14); pdf.text(tagline, pageWidth/2, pageHeight*0.5, { align: 'center' }); }
          pdf.setDrawColor(212,175,55);
          pdf.setLineWidth(1);
          pdf.line(pageWidth*0.3, pageHeight*0.52, pageWidth*0.7, pageHeight*0.52);
          pdf.setFontSize(16); pdf.setFont('helvetica','normal'); pdf.text(author, pageWidth/2, pageHeight*0.6, { align: 'center' });

          // Title page
          pdf.addPage();
          pdf.setFillColor(250,248,245);
          pdf.rect(0,0,pageWidth,pageHeight,'F');
          pdf.setTextColor(42,42,42);
          pdf.setFontSize(24); pdf.setFont('helvetica','bold'); pdf.text(title, pageWidth/2, pageHeight*0.4, { align: 'center' });
          if (subtitle) { pdf.setFontSize(18); pdf.text(subtitle, pageWidth/2, pageHeight*0.44, { align: 'center' }); }
          pdf.setFontSize(14); pdf.setFont('helvetica','normal'); pdf.text('by', pageWidth/2, pageHeight*0.46, { align: 'center' }); pdf.setFontSize(18); pdf.text(author, pageWidth/2, pageHeight*0.52, { align: 'center' });

          // Copyright page
          pdf.addPage();
          pdf.setFillColor(250,248,245); pdf.rect(0,0,pageWidth,pageHeight,'F');
          pdf.setTextColor(136,136,136); pdf.setFontSize(10); pdf.setFont('helvetica','normal');
          const copyrightText = [
            `Copyright ¬© ${currentYear} ${imprint}.`,
            'All rights reserved.',
            'No part of this book may be reproduced in any form without written permission from the publisher.',
            '',
            `Published by ${imprint}`
          ];
          let copyY = pageHeight/2;
          copyrightText.forEach(line=>{ pdf.text(line, pageWidth/2, copyY, { align:'center' }); copyY += 15; });

          // Content pages
          const content = documentContent || manuscriptContent || sampleContent;
          const paragraphs = content.split('\n\n').filter(p => p.trim());
          pdf.addPage();
          pdf.setFillColor(250,248,245); pdf.rect(0,0,pageWidth,pageHeight,'F');
          let currentY = margin + 40;
          let pageNum = 4;
          pdf.setTextColor(42,42,42); pdf.setFontSize(parseInt(fontSize)); pdf.setFont('helvetica','normal');

          paragraphs.forEach((para, index) => {
            const isChapter = para.match(/^(Chapter|CHAPTER|Part|PART)\s/i);
            if (isChapter) {
              if (currentY > margin + 100) {
                if (showPageNumbers) {
                  pdf.setFontSize(10); pdf.setTextColor(136,136,136); pdf.text(String(pageNum - 2), pageWidth/2, pageHeight - 25, { align: 'center' });
                }
                if (showHeader && index > 0) {
                  pdf.setFontSize(10); pdf.setTextColor(136,136,136); pdf.text(title, margin, margin - 10);
                }
                pdf.addPage(); pdf.setFillColor(250,248,245); pdf.rect(0,0,pageWidth,pageHeight,'F'); currentY = margin + 40; pageNum++;
              }
              pdf.setFontSize(18); pdf.setFont('helvetica','bold'); pdf.setTextColor(212,175,55); pdf.text(para.trim(), pageWidth/2, currentY, { align: 'center' });
              currentY += 45;
              pdf.setFontSize(parseInt(fontSize)); pdf.setFont('helvetica','normal'); pdf.setTextColor(42,42,42);
            } else {
              const lines = pdf.splitTextToSize(para.trim(), contentWidth);
              lines.forEach(line => {
                if (currentY > pageHeight - margin - 35) {
                  if (showPageNumbers) { pdf.setFontSize(10); pdf.setTextColor(136,136,136); pdf.text(String(pageNum - 2), pageWidth/2, pageHeight - 25, { align: 'center' }); }
                  if (showHeader) { pdf.setFontSize(10); pdf.setTextColor(136,136,136); pdf.text(title, margin, margin - 10); }
                  pdf.addPage(); pdf.setFillColor(250,248,245); pdf.rect(0,0,pageWidth,pageHeight,'F'); currentY = margin + 30; pageNum++;
                  pdf.setFontSize(parseInt(fontSize)); pdf.setTextColor(42,42,42);
                }
                pdf.text(line, margin, currentY); currentY += lineHeight;
              });
              currentY += lineHeight * 0.4;
            }
          });

          if (showPageNumbers) { pdf.setFontSize(10); pdf.setTextColor(136,136,136); pdf.text(String(pageNum - 2), pageWidth/2, pageHeight - 25, { align: 'center' }); }
          if (showHeader) { pdf.setFontSize(10); pdf.setTextColor(136,136,136); pdf.text(title, margin, margin - 10); }

          const filename = `${title.replace(/[^a-z0-9]/gi,'_')}.pdf`;
          pdf.save(filename);
          showNotification(`‚úì PDF Downloaded: ${filename}`);
        } catch (err) {
          console.error('PDF Error', err);
          showNotification('Error creating PDF', 'error');
        } finally { setIsExporting(false); }
      };

      // EPUB export (same approach as earlier)
      const exportEPUB = async () => {
        setIsExporting(true);
        showNotification('üìö Creating EPUB...');
        try {
          const zip = new JSZip();
          const title = ebookTitle || 'Untitled Book';
          const subtitle = ebookSubtitle || '';
          const author = ebookAuthor || 'Unknown Author';
          const imprint = ebookImprint || author;
          const currentYear = new Date().getFullYear();
          const content = documentContent || manuscriptContent || sampleContent;
          const uuid = 'urn:uuid:' + Date.now() + '-' + Math.random().toString(36).substr(2,9);

          const coverUrl = getCurrentCoverImage();
          let coverData = null;
          if (coverUrl) {
            const response = await fetch(coverUrl.startsWith('data:') ? coverUrl : coverUrl);
            coverData = await response.blob();
            zip.file('OEBPS/cover.jpg', coverData, { binary: true });
          }

          zip.file('mimetype', 'application/epub+zip', { compression: 'STORE' });
          zip.file('META-INF/container.xml', `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles>
</container>`);

          let manifestItems = `
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    <item id="nav" href="nav.xhtml" media-type="application/xhtml+xml" properties="nav"/>
    <item id="style" href="style.css" media-type="text/css"/>
    <item id="titlepage" href="titlepage.xhtml" media-type="application/xhtml+xml"/>
    <item id="copyright" href="copyright.xhtml" media-type="application/xhtml+xml"/>
    <item id="chapter1" href="chapter1.xhtml" media-type="application/xhtml+xml"/>`;
          let spineItems = `
    <itemref idref="titlepage"/>
    <itemref idref="copyright"/>
    <itemref idref="chapter1"/>`;
          let navItems = `
    <li><a href="titlepage.xhtml">Title Page</a></li>
    <li><a href="copyright.xhtml">Copyright</a></li>
    <li><a href="chapter1.xhtml">Content</a></li>`;

          if (coverData) {
            manifestItems += `
    <item id="cover" href="cover.xhtml" media-type="application/xhtml+xml" properties="cover"/>
    <item id="cover-image" href="cover.jpg" media-type="image/jpeg" properties="cover-image"/>`;
            spineItems = `<itemref idref="cover"/>` + spineItems;
            navItems = `<li><a href="cover.xhtml">Cover</a></li>` + navItems;
          }

          zip.file('OEBPS/content.opf', `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" version="3.0" unique-identifier="BookId">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:identifier id="BookId">${uuid}</dc:identifier>
    <dc:title>${title}${subtitle ? `: ${subtitle}` : ''}</dc:title>
    <dc:creator>${author}</dc:creator>
    <dc:language>en</dc:language>
    <dc:rights>Copyright ¬© ${currentYear} ${imprint}. All rights reserved.</dc:rights>
    <meta property="dcterms:modified">${new Date().toISOString().split('.')[0]}Z</meta>
    ${coverData ? `<meta name="cover" content="cover-image"/>` : ''}
  </metadata>
  <manifest>
    ${manifestItems}
  </manifest>
  <spine toc="ncx">
    ${spineItems}
  </spine>
</package>`);

          zip.file('OEBPS/toc.ncx', `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head><meta name="dtb:uid" content="${uuid}"/></head>
  <docTitle><text>${title}</text></docTitle>
  <navMap>
    <navPoint id="titlepage" playOrder="1"><navLabel><text>Title Page</text></navLabel><content src="titlepage.xhtml"/></navPoint>
    <navPoint id="copyright" playOrder="2"><navLabel><text>Copyright</text></navLabel><content src="copyright.xhtml"/></navPoint>
    <navPoint id="chapter1" playOrder="3"><navLabel><text>Content</text></navLabel><content src="chapter1.xhtml"/></navPoint>
  </navMap>
</ncx>`);

          zip.file('OEBPS/nav.xhtml', `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head><title>Table of Contents</title><link rel="stylesheet" type="text/css" href="style.css"/></head>
<body>
  <nav epub:type="toc"><h1>Table of Contents</h1>
    <ol>${navItems}</ol>
  </nav>
</body>
</html>`);

          zip.file('OEBPS/style.css', `
body { font-family: Georgia, serif; font-size: ${fontSize}pt; line-height: ${lineSpacing}; margin: 1em; color: #2a2a2a; }
h1 { font-size: 1.8em; text-align: center; margin: 1.5em 0 1em; color: #D4AF37; }
p { text-align: justify; text-indent: 1.5em; margin: 0.5em 0; }
.title-page { text-align: center; padding-top: 30%; }
.title { font-size: 2em; margin-bottom: 0.5em; }
.author { font-size: 1.3em; color: #666; }
.drop-cap { float: left; font-size: 3em; line-height: 0.8; padding-right: 0.1em; color: #D4AF37; }
.cover { text-align: center; margin: 0; padding: 0; }
.cover img { width: 100%; height: auto; }`);

          zip.file('OEBPS/titlepage.xhtml', `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>${title}</title><link rel="stylesheet" type="text/css" href="style.css"/></head>
<body><div class="title-page"><h1 class="title">${title}</h1>${subtitle ? `<h2>${subtitle}</h2>` : ''}${tagline ? `<p>${tagline}</p>` : ''}<p class="author">by ${author}</p></div></body>
</html>`);

          zip.file('OEBPS/copyright.xhtml', `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>Copyright</title><link rel="stylesheet" type="text/css" href="style.css"/></head>
<body>
  <p style="text-align: center; font-size: 0.8em;">Copyright ¬© ${currentYear} ${imprint}. All rights reserved.</p>
  <p style="text-align: center; font-size: 0.8em;">Published by ${imprint}</p>
</body>
</html>`);

          if (coverData) {
            zip.file('OEBPS/cover.xhtml', `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>Cover</title><link rel="stylesheet" type="text/css" href="style.css"/></head>
<body><div class="cover"><img src="cover.jpg" alt="Cover"/></div></body>
</html>`);
          }

          const paragraphs = content.split('\n\n').filter(p => p.trim());
          let htmlContent = '';
          paragraphs.forEach((para, idx) => {
            const trimmed = para.trim();
            if (trimmed.match(/^(Chapter|CHAPTER|Part|PART)\s/i)) {
              htmlContent += `<h1>${trimmed}</h1>\n`;
            } else {
              if (idx === 0 || paragraphs[idx - 1]?.match(/^(Chapter|CHAPTER|Part|PART)\s/i)) {
                const firstChar = trimmed.charAt(0);
                const rest = trimmed.slice(1);
                htmlContent += `<p><span class="drop-cap">${firstChar}</span>${rest}</p>\n`;
              } else {
                htmlContent += `<p>${trimmed}</p>\n`;
              }
            }
          });

          zip.file('OEBPS/chapter1.xhtml', `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>${title}</title><link rel="stylesheet" type="text/css" href="style.css"/></head>
<body>${htmlContent}</body>
</html>`);

          const blob = await zip.generateAsync({ type: 'blob', mimeType: 'application/epub+zip', compression: 'DEFLATE' });
          const filename = `${title.replace(/[^a-z0-9]/gi,'_')}.epub`;
          saveAs(blob, filename);
          showNotification(`‚úì EPUB Downloaded: ${filename}`);
        } catch (err) {
          console.error('EPUB Error', err);
          showNotification('Error creating EPUB', 'error');
        } finally { setIsExporting(false); }
      };

      // Download cover image
      const downloadCoverImage = async () => {
        const coverImage = getCurrentCoverImage();
        if (!coverImage) { showNotification('No cover image', 'error'); return; }
        setIsExporting(true);
        try {
          if (coverImage.startsWith('data:')) {
            const link = document.createElement('a'); link.href = coverImage; link.download = `${(ebookTitle||'cover').replace(/[^a-z0-9]/gi,'_')}_cover.png`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
          } else {
            const response = await fetch(coverImage); const blob = await response.blob(); saveAs(blob, `${(ebookTitle||'cover').replace(/[^a-z0-9]/gi,'_')}_cover.jpg`);
          }
          showNotification('‚úì Cover downloaded!');
        } catch (err) {
          showNotification('Error downloading cover', 'error');
        } finally { setIsExporting(false); }
      };

      const exportTXT = () => {
        const content = documentContent || manuscriptContent || sampleContent;
        const title = ebookTitle || 'Untitled Book';
        const author = ebookAuthor || 'Unknown Author';
        const fullText = `${title}\nby ${author}\n\n${'='.repeat(50)}\n\n${content}`;
        const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, `${title.replace(/[^a-z0-9]/gi,'_')}.txt`);
        showNotification('‚úì TXT downloaded!');
      };

      // Local grammar quick fix
      const grammarQuickFix = (text='') => {
        if (!text) return text;
        let s = text.replace(/\t/g,' ').replace(/\s{2,}/g,' ');
        s = s.replace(/\n{3,}/g, '\n\n');
        s = s.replace(/([.!?])\s+([a-z])/g, (m,p1,p2) => p1 + ' ' + p2.toUpperCase());
        s = s.replace(/^\s*[a-z]/, (m) => m.toUpperCase());
        return s.trim();
      };

      // Set preset
      const setPreset = (preset) => {
        setPageSize(preset.pageSize); setFontSize(preset.fontSize); setLineSpacing(preset.lineSpacing);
        showNotification(`‚úì Preset: ${preset.name} applied`);
      };

      // Auto-save to localStorage (simple)
      useEffect(()=>{
        const data = {
          ebookTitle, ebookSubtitle, ebookTagline, ebookAuthor, ebookImprint,
          documentContent, fontSize, lineSpacing, pageSize, showPageNumbers, showHeader,
          generatedCover, generatedImages, uploadedCoverImage, chapters
        };
        try { localStorage.setItem('ebookStudioData', JSON.stringify(data)); } catch (e) {}
      }, [ebookTitle, ebookSubtitle, ebookTagline, ebookAuthor, ebookImprint, documentContent, fontSize, lineSpacing, pageSize, showPageNumbers, showHeader, generatedCover, generatedImages, uploadedCoverImage, chapters]);

      // Load from localStorage on mount
      useEffect(()=>{
        try {
          const raw = localStorage.getItem('ebookStudioData');
          if (raw) {
            const parsed = JSON.parse(raw);
            setEbookTitle(parsed.ebookTitle || ''); setEbookSubtitle(parsed.ebookSubtitle || ''); setEbookTagline(parsed.ebookTagline || '');
            setEbookAuthor(parsed.ebookAuthor || ''); setEbookImprint(parsed.ebookImprint || '');
            setDocumentContent(parsed.documentContent || ''); setManuscriptContent(parsed.documentContent || '');
            setFontSize(parsed.fontSize || '12'); setLineSpacing(parsed.lineSpacing || '1.6'); setPageSize(parsed.pageSize || '6x9');
            setShowPageNumbers(parsed.showPageNumbers ?? true); setShowHeader(parsed.showHeader ?? true);
            setGeneratedCover(parsed.generatedCover || null); setGeneratedImages(parsed.generatedImages || []);
            setUploadedCoverImage(parsed.uploadedCoverImage || null);
            setChapters(parsed.chapters || []);
          }
        } catch (e) { console.warn('Load fail', e); }
      }, []);

      // UI subcomponents
      const TabButton = ({ id, label, icon }) => (
        <button onClick={() => setActiveTab(id)} style={{
          padding: '10px 14px', border: 'none', background: activeTab === id ? 'linear-gradient(135deg,#D4AF37 0%,#F4E5B2 50%)' : 'transparent',
          color: activeTab === id ? '#0D0D0D' : '#808080', fontSize: 12, fontWeight: 600, letterSpacing: '1px', textTransform: 'uppercase', cursor: 'pointer', borderRadius: activeTab===id?6:0
        }}>
          <span style={{ marginRight: 8 }}>{icon}</span>{label}
        </button>
      );

      const BookCover = ({ size='large' }) => {
        const coverImage = getCurrentCoverImage();
        const isLarge = size === 'large';
        const width = isLarge ? 260 : 160; const height = isLarge ? 390 : 240;
        return (
          <div style={{
            width: width + 'px', height: height + 'px',
            background: coverImage ? 'transparent' : 'linear-gradient(145deg,#252530 0%, #1a1a22 100%)',
            borderRadius: 6, boxShadow: '18px 18px 60px rgba(0,0,0,0.5)', position: 'relative', overflow: 'hidden', flexShrink: 0
          }}>
            {coverImage && (<img src={coverImage} alt="Cover" crossOrigin="anonymous" style={{ position:'absolute', top:0, left:0, width:'100%', height:'100%', objectFit:'cover', opacity: imageOpacity/100 }} />)}
            <div style={{ position:'absolute', top:0, left:0, right:0, height:'6px', background:'linear-gradient(90deg,#D4AF37,#F4E5B2,#D4AF37)', zIndex:10 }} />
            <div style={{ position:'absolute', top:0,left:0,right:0,bottom:0,zIndex:5,padding:isLarge?'20px 18px':'12px 10px', display:'flex', flexDirection:'column', justifyContent:'space-between', background: coverImage ? `linear-gradient(180deg, rgba(0,0,0,${overlayOpacity/100}) 0%, transparent 30%, transparent 70%, rgba(0,0,0,${Math.min(overlayOpacity/100 + 0.2,1)}) 100%)` : 'transparent' }}>
              { (coverImage || ebookTitle) ? (
                <>
                  <div style={{ textAlign:'center', marginTop: isLarge?'30px':'12px' }}>
                    <div style={{ fontSize: isLarge? '10px':'8px', letterSpacing:'2px', color:'#D4AF37', marginBottom:10, textTransform:'uppercase' }}>{coverStyle} Edition</div>
                    <h3 style={{ fontSize: isLarge? '20px':'14px', fontWeight:400, color:'#fff', lineHeight:1.2, margin:0, fontFamily:"'Playfair Display', Georgia, serif" }}>{ebookTitle || 'Your Title'}</h3>
                  </div>
                  <div style={{ textAlign:'center' }}>
                    <div style={{ width: '35px', height:'1px', background: 'linear-gradient(90deg, transparent, #D4AF37, transparent)', margin:'0 auto 10px' }} />
                    <p style={{ fontSize: isLarge? '12px':'9px', color:'#E0E0E0', margin:0, textTransform:'uppercase' }}>{ebookAuthor || 'Author Name'}</p>
                  </div>
                </>
              ) : (
                <div style={{ display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', height:'100%', color:'#404050' }}>
                  <div style={{ fontSize: isLarge? '38px':'24px', opacity:0.5 }}>üìö</div>
                  <p style={{ fontSize: '10px', textAlign: 'center' }}>Add image to preview</p>
                </div>
              )}
            </div>
          </div>
        );
      };

      // Render
      return (
        <div style={{ minHeight:'100vh', paddingBottom: 40 }}>
          {/* Notification */}
          { notification && (
            <div style={{ position:'fixed', top:16, right:16, zIndex:9999, padding:'12px 18px', borderRadius:8, background: notification.type === 'error' ? 'linear-gradient(135deg,#8B0000,#5C0000)' : 'linear-gradient(135deg,#D4AF37,#AA8C2C)', color: notification.type==='error'? '#fff':'#0D0D0D', fontWeight:700, boxShadow:'0 8px 40px rgba(0,0,0,0.4)'}}>{notification.message}</div>
          )}

          {/* Export overlay */}
          { isExporting && (
            <div style={{ position:'fixed', left:0, right:0, top:0, bottom:0, background:'rgba(0,0,0,0.6)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:9998 }}>
              <div style={{ background:'rgba(12,12,16,0.96)', border:'1px solid rgba(212,175,55,0.12)', padding:30, borderRadius:10, textAlign:'center', color:'#D4AF37' }}>
                <div style={{ width:48, height:48, margin:'0 auto 12px', border:'3px solid rgba(212,175,55,0.25)', borderTop:'3px solid #D4AF37', borderRadius:'50%', animation:'spin 1s linear infinite' }} />
                <div style={{ fontWeight:700, letterSpacing:1 }}>WORKING‚Ä¶</div>
              </div>
            </div>
          )}

          {/* Header */}
          <header style={{ padding:'20px 18px', borderBottom:'1px solid rgba(212,175,55,0.08)', background:'rgba(10,10,15,0.85)' }}>
            <div style={{ maxWidth:1200, margin:'0 auto', display:'flex', justifyContent:'space-between', alignItems:'center', gap:12, flexWrap:'wrap' }}>
              <div>
                <h1 style={{ fontSize:'clamp(16px,3.2vw,22px)', margin:0, fontWeight:300, letterSpacing:4, textTransform:'uppercase', background:'linear-gradient(135deg,#D4AF37,#F4E5B2)', WebkitBackgroundClip:'text', WebkitTextFillColor:'transparent' }}>Premium Ebook Studio</h1>
                <div style={{ fontSize:10, color:'#808080', marginTop:4, textTransform:'uppercase' }}>Real PDF & EPUB Export</div>
              </div>

              <div style={{ display:'flex', gap:8 }}>
                <button onClick={exportPDF} disabled={isExporting} style={{ ...primaryBtnStyle, fontSize:12 }}>üìÑ PDF</button>
                <button onClick={exportEPUB} disabled={isExporting} style={{ ...secondaryBtnStyle, border:'1px solid rgba(212,175,55,0.22)' }}>üìö EPUB</button>
              </div>
            </div>
          </header>

          {/* Nav tabs */}
          <nav style={{ display:'flex', justifyContent:'center', gap:6, padding:'12px 12px', borderBottom:'1px solid rgba(212,175,55,0.06)', background:'rgba(12,12,18,0.6)' }}>
            <TabButton id="cover" label="Cover" icon="üìñ" />
            <TabButton id="upload" label="Manuscript" icon="üì§" />
            <TabButton id="template" label="Templates" icon="‚ú®" />
            <TabButton id="preview" label="Preview" icon="üëÅ" />
            <TabButton id="export" label="Export" icon="üíæ" />
          </nav>

          <main style={{ maxWidth:1200, margin:'24px auto', padding:'0 16px' }}>

            {/* MAIN LAYOUT */}
            { activeTab === 'cover' && (
              <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit,minmax(300px,1fr))', gap:24 }}>
                <div className="card">
                  <h3 style={{ color:'#D4AF37', marginBottom:12 }}>üì∑ Upload Image</h3>
                  <input ref={imageInputRef} type="file" accept="image/*" onChange={handleImageUpload} style={{ display:'none' }} />
                  <div onClick={() => imageInputRef.current?.click()} style={{ cursor:'pointer', border:'2px dashed rgba(212,175,55,0.35)', padding:18, borderRadius:10, textAlign:'center' }}>
                    <div style={{ fontSize:28 }}>üñºÔ∏è</div>
                    <p style={{ color:'#D4AF37', margin:'8px 0', fontWeight:700 }}>Click to upload</p>
                    <p style={{ color:'#888' }}>JPG, PNG, GIF, WebP</p>
                  </div>
                  { uploadedCoverImage && (
                    <div style={{ marginTop:12, padding:10, background:'rgba(212,175,55,0.06)', borderRadius:8, display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                      <div style={{ overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap', color:'#D4AF37' }}>{uploadedCoverImage.name}</div>
                      <button onClick={() => { setImageSource('upload'); showNotification('‚úì Using uploaded image'); }} style={{ ...secondaryBtnStyle, fontSize:11 }}>{ imageSource === 'upload' ? '‚úì Active' : 'Use' }</button>
                    </div>
                  )}

                  <hr style={{ opacity:0.06, margin: '18px 0' }} />

                  <div style={{ marginTop:8 }}>
                    <h3 style={{ color:'#D4AF37' }}>üé¨ AI Generate</h3>
                    <div style={{ margin:'10px 0' }}>
                      <label style={{ fontSize:11, color:'#888' }}>Style</label>
                      <div style={{ display:'grid', gridTemplateColumns:'repeat(3,1fr)', gap:8, marginTop:8 }}>
                        { coverStyles.map(s => (
                          <button key={s.id} onClick={()=>setCoverStyle(s.id)} style={{ padding:8, borderRadius:6, border: coverStyle===s.id ? '1px solid rgba(212,175,55,0.6)' : '1px solid rgba(255,255,255,0.03)', background: coverStyle===s.id ? 'rgba(212,175,55,0.08)' : 'transparent', color:'#E8E8E8' }}>
                            <div style={{ fontSize:16 }}>{s.icon}</div>
                            <div style={{ fontSize:12 }}>{s.name}</div>
                          </button>
                        )) }
                      </div>
                    </div>

                    <label style={{ fontSize:11, color:'#888' }}>Describe Cover</label>
                    <textarea value={coverPrompt} onChange={(e)=>setCoverPrompt(e.target.value)} placeholder="e.g., Woman on cliff at sunset, dramatic clouds..." rows={2} style={{ width:'100%', padding:10, borderRadius:8, marginTop:8, background:'rgba(255,255,255,0.02)', color:'#E8E8E8', border:'1px solid rgba(255,255,255,0.03)' }} />
                    <div style={{ display:'flex', gap:8, marginTop:8, flexWrap:'wrap' }}>
                      { ['Sunset mountains','Forest path','Ocean night','City lights'].map(p=>(
                        <button key={p} onClick={()=>setCoverPrompt(p)} style={{ padding:'6px 10px', borderRadius:999, border:'1px solid rgba(255,255,255,0.04)', background:'transparent', color:'#ccc' }}>{p}</button>
                      )) }
                    </div>
                    <button onClick={generateCover} disabled={isGenerating || !coverPrompt.trim()} style={{ marginTop:12, width:'100%', ...primaryBtnStyle }}>{ isGenerating ? '‚è≥ Generating...' : '‚ú¶ Generate AI Cover' }</button>
                  </div>

                  <div style={{ marginTop:12 }}>
                    <h3 style={{ color:'#D4AF37' }}>üéö Controls</h3>
                    <div style={{ marginTop:8 }}>
                      <label style={{ fontSize:11, color:'#999' }}>Image Opacity <span style={{ float:'right', color:'#D4AF37' }}>{imageOpacity}%</span></label>
                      <input type="range" min="0" max="100" value={imageOpacity} onChange={(e)=>setImageOpacity(Number(e.target.value))} style={{ width:'100%' }} />
                    </div>
                    <div style={{ marginTop:10 }}>
                      <label style={{ fontSize:11, color:'#999' }}>Text Overlay <span style={{ float:'right', color:'#D4AF37' }}>{overlayOpacity}%</span></label>
                      <input type="range" min="0" max="100" value={overlayOpacity} onChange={(e)=>setOverlayOpacity(Number(e.target.value))} style={{ width:'100%' }} />
                    </div>
                  </div>
                </div>

                <div style={{ display:'flex', flexDirection:'column', gap:18 }}>
                  <div className="card">
                    <h3 style={{ color:'#D4AF37' }}>üìù Book Details</h3>
                    <div style={{ display:'grid', gap:10 }}>
                      <input type="text" value={ebookTitle} onChange={(e)=>setEbookTitle(e.target.value)} placeholder="Title" style={{ padding:10, borderRadius:8, border:'1px solid rgba(255,255,255,0.03)', background:'transparent', color:'#E8E8E8' }} />
                      <input type="text" value={ebookSubtitle} onChange={(e)=>setEbookSubtitle(e.target.value)} placeholder="Subtitle (optional)" style={{ padding:10, borderRadius:8, border:'1px solid rgba(255,255,255,0.03)', background:'transparent', color:'#E8E8E8' }} />
                      <input type="text" value={ebookAuthor} onChange={(e)=>setEbookAuthor(e.target.value)} placeholder="Author" style={{ padding:10, borderRadius:8, border:'1px solid rgba(255,255,255,0.03)', background:'transparent', color:'#E8E8E8' }} />
                      <input type="text" value={ebookImprint} onChange={(e)=>setEbookImprint(e.target.value)} placeholder="Imprint / Publisher" style={{ padding:10, borderRadius:8, border:'1px solid rgba(255,255,255,0.03)', background:'transparent', color:'#E8E8E8' }} />
                    </div>
                  </div>

                  <div className="card" style={{ alignItems:'center', display:'flex', flexDirection:'column', gap:12 }}>
                    <h3 style={{ color:'#D4AF37', alignSelf:'flex-start' }}>üëÅ Preview</h3>
                    <BookCover size="large" />
                    <div style={{ marginTop:10, padding:'6px 12px', background:'rgba(212,175,55,0.08)', borderRadius:12, color:'#D4AF37' }}>{ imageSource === 'upload' ? 'üì∑ Uploaded' : imageSource === 'ai' ? 'üé¨ AI Generated' : 'üìö No Image' }</div>
                    { getCurrentCoverImage() && <button onClick={downloadCoverImage} style={{ ...secondaryBtnStyle, marginTop:8 }}>‚¨á Download Cover</button> }
                  </div>
                </div>
              </div>
            )}

            {/* UPLOAD TAB */}
            { activeTab === 'upload' && (
              <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit,minmax(300px,1fr))', gap:24 }}>
                {/* Left: Upload area */}
                <div style={{ minWidth:320 }}>
                  <div className="card">
                    <h3 style={{ color:'#D4AF37' }}>üì§ Upload Manuscript</h3>

                    {/* Drag & drop area */}
                    <div
                      onDrop={(e)=>{ e.preventDefault(); e.stopPropagation(); setDragActive(false); const file = e.dataTransfer.files && e.dataTransfer.files[0]; if (file) handleFileUpload(file); }}
                      onDragOver={(e)=>{ e.preventDefault(); e.stopPropagation(); setDragActive(true); }}
                      onDragLeave={() => setDragActive(false)}
                      onClick={() => fileInputRef.current?.click()}
                      style={{
                        border: `2px dashed ${dragActive ? '#D4AF37' : 'rgba(212,175,55,0.3)'}`,
                        background: dragActive ? 'rgba(212,175,55,0.12)' : 'rgba(212,175,55,0.04)',
                        padding: 28,
                        borderRadius: 12,
                        textAlign:'center',
                        cursor:'pointer'
                      }}
                    >
                      <div style={{ fontSize:36 }}>{ dragActive ? 'üì•' : 'üìÑ' }</div>
                      <div style={{ marginTop:8, color:'#D4AF37', fontWeight:700 }}>Click or drag file here</div>
                      <div style={{ color:'#999', marginTop:6, fontSize:12 }}>TXT, DOC, DOCX, RTF, MD</div>
                    </div>

                    <input ref={fileInputRef} type="file" accept=".txt,.doc,.docx,.rtf,.md" onChange={handleFileUpload} style={{ display:'none' }} />

                    { uploadedFile && uploadedDoc && (
                      <div style={{ marginTop:12, padding:12, background:'rgba(212,175,55,0.06)', borderRadius:8 }}>
                        <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between' }}>
                          <div style={{ display:'flex', alignItems:'center', gap:10 }}>
                            <div style={{ fontSize:20 }}>{ fileIcons[getFileExtension(uploadedFile.name)] || fileIcons.default }</div>
                            <div style={{ overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>
                              <div style={{ color:'#D4AF37', fontWeight:700 }}>{uploadedDoc.name || uploadedFile.name}</div>
                              <div style={{ fontSize:12, color:'#888' }}>{uploadedDoc.size}</div>
                            </div>
                          </div>
                          <button onClick={()=>showNotification('‚úì Manuscript kept')} style={{ ...secondaryBtnStyle, fontSize:12 }}>‚úì Uploaded</button>
                        </div>

                        {/* Stats */}
                        <div style={{ marginTop:12, display:'flex', gap:10, flexWrap:'wrap' }}>
                          <div style={{ padding:8, borderRadius:8, background:'#fff', color:'#222', minWidth:120 }}>
                            <div style={{ fontSize:12, fontWeight:700 }}>Words</div>
                            <div style={{ fontSize:14 }}>{ getStats(manuscriptContent).words.toLocaleString() }</div>
                          </div>
                          <div style={{ padding:8, borderRadius:8, background:'#fff', color:'#222', minWidth:120 }}>
                            <div style={{ fontSize:12, fontWeight:700 }}>Chars</div>
                            <div style={{ fontSize:14 }}>{ getStats(manuscriptContent).characters.toLocaleString() }</div>
                          </div>
                          <div style={{ padding:8, borderRadius:8, background:'#fff', color:'#222', minWidth:150 }}>
                            <div style={{ fontSize:12, fontWeight:700 }}>Est. Read</div>
                            <div style={{ fontSize:14 }}>{ getStats(manuscriptContent).readingTime } min</div>
                          </div>
                        </div>

                        {/* Preview first 200 chars */}
                        <div style={{ marginTop:12, padding:10, background:'rgba(0,0,0,0.03)', borderRadius:8 }}>
                          <div style={{ fontSize:12, color:'#888', marginBottom:6, fontWeight:700 }}>Preview (first 200 chars)</div>
                          <div style={{ color:'#ddd', fontSize:13, lineHeight:1.5, whiteSpace:'pre-wrap' }}>{ (manuscriptContent || '').slice(0,200) || '(no content)' }{ (manuscriptContent && manuscriptContent.length>200) ? '...' : '' }</div>
                        </div>

                        {/* Actions: Clean, convert, detect, TOC, grammar, AI */}
                        <div style={{ marginTop:12, display:'flex', gap:8, flexWrap:'wrap' }}>
                          <button onClick={()=>{
                            const cleaned = cleanManuscript(manuscriptContent || '');
                            setManuscriptContent(cleaned); setDocumentContent(cleaned);
                            showNotification('‚ú® Manuscript cleaned & formatted');
                          }} style={primaryBtnStyle}>‚ú® Clean & Format</button>

                          <button onClick={()=>{
                            const md = toMarkdown(manuscriptContent || '');
                            setManuscriptContent(md); setDocumentContent(md);
                            showNotification('üìù Converted to Markdown');
                          }} style={secondaryBtnStyle}>üìù Convert ‚Üí MD</button>

                          <button onClick={()=>{
                            const ch = detectChaptersFromText(manuscriptContent || '');
                            setChapters(ch);
                            showNotification(`üß≠ Detected ${ch.length} section(s)`);
                          }} style={secondaryBtnStyle}>üß≠ Detect Chapters</button>

                          <button onClick={()=>{
                            const ch = chapters.length ? chapters : detectChaptersFromText(manuscriptContent||'');
                            const toc = generateTOCFromChapters(ch);
                            const newDoc = `Table of Contents\n\n${toc}\n\n${manuscriptContent||''}`;
                            setManuscriptContent(newDoc); setDocumentContent(newDoc); showNotification('üìö TOC generated');
                          }} style={secondaryBtnStyle}>üìö Generate TOC</button>

                          <button onClick={()=>{
                            const fixed = grammarQuickFix(manuscriptContent || '');
                            setManuscriptContent(fixed); setDocumentContent(fixed); showNotification('‚úçÔ∏è Grammar quick-fix applied');
                          }} style={secondaryBtnStyle}>‚úçÔ∏è Grammar Fix</button>

                          <button onClick={async ()=>{
                            if (!aiApiKey) { showNotification('Provide API key to use AI features', 'error'); return; }
                            setIsExporting(true);
                            try {
                              const edited = await aiEditRequest({ inputText: manuscriptContent || '', apiKey: aiApiKey, mode: 'rewrite' });
                              setManuscriptContent(edited); setDocumentContent(edited); showNotification('ü§ñ AI rewrite complete');
                            } catch (err) { console.error(err); showNotification('AI rewrite failed', 'error'); } finally { setIsExporting(false); }
                          }} style={ctaBtnStyle}>ü§ñ AI Rewrite</button>

                          <button onClick={async ()=>{
                            if (!aiApiKey) { showNotification('Provide API key to use AI features', 'error'); return; }
                            setIsExporting(true);
                            try {
                              const suggested = await aiEditRequest({ inputText: manuscriptContent || '', apiKey: aiApiKey, mode: 'suggestTocs' });
                              let parsed = [];
                              try { parsed = JSON.parse(suggested); } catch(e){ parsed = []; }
                              if (Array.isArray(parsed) && parsed.length) {
                                const tocLines = parsed.map((x,i)=> `${i+1}. ${x.title} - ${x.description||''}`).join('\n');
                                const newDoc = `Table of Contents\n\n${tocLines}\n\n${manuscriptContent}`;
                                setManuscriptContent(newDoc); setDocumentContent(newDoc); showNotification('‚ú® AI editorial pass applied (TOC)');
                              } else {
                                setManuscriptContent(suggested); setDocumentContent(suggested); showNotification('‚ú® AI editorial pass applied');
                              }
                            } catch (err) {
                              console.error(err); showNotification('AI editorial pass failed', 'error');
                            } finally { setIsExporting(false); }
                          }} style={{ ...ctaBtnStyle, background:'#B8860B' }}>üß† Full AI Edit</button>
                        </div>

                        {/* API key */}
                        <div style={{ marginTop:12, display:'flex', gap:8, alignItems:'center' }}>
                          <input placeholder="AI API key (optional)" value={aiApiKey} onChange={(e)=>setAiApiKey(e.target.value)} style={{ flex:1, padding:8, borderRadius:8, border:'1px solid rgba(255,255,255,0.04)', background:'transparent', color:'#fff' }} />
                          <div style={{ fontSize:13, color:'#999' }}>üîí</div>
                        </div>

                        {/* Export from upload */}
                        <div style={{ marginTop:12, display:'flex', gap:8 }}>
                          <button onClick={() => { const blob = new Blob([manuscriptContent || ''], { type:'text/plain' }); saveAs(blob, `${(ebookTitle||'manuscript').replace(/[^a-z0-9]/gi,'_')}.txt`); showNotification('‚úì TXT exported'); }} style={secondaryBtnStyle}>‚¨á Export TXT</button>
                          <button onClick={() => { const md = toMarkdown(manuscriptContent||''); const blob = new Blob([md], { type:'text/markdown' }); saveAs(blob, `${(ebookTitle||'manuscript').replace(/[^a-z0-9]/gi,'_')}.md`); showNotification('‚úì MD exported'); }} style={secondaryBtnStyle}>‚¨á Export MD</button>
                          <button onClick={() => setManuscriptPreviewOpen(p => !p)} style={secondaryBtnStyle}>{ manuscriptPreviewOpen ? 'Hide Preview' : 'Show Preview' }</button>
                        </div>

                        { manuscriptPreviewOpen && (
                          <div style={{ marginTop:12, background:'#fff', color:'#222', padding:12, borderRadius:8, maxHeight:260, overflowY:'auto', border:'1px solid #eee' }}>
                            <pre style={{ whiteSpace:'pre-wrap', fontFamily:'inherit', margin:0 }}>{ manuscriptContent || '(no content)' }</pre>
                          </div>
                        )}

                      </div>
                    ) }
                  </div>
                </div>

                {/* Right: structure / chapters */}
                <div>
                  <div className="card">
                    <h3 style={{ color:'#D4AF37' }}>üìë Structure</h3>
                    { chapters && chapters.length > 0 ? (
                      <>
                        <div style={{ display:'flex', justifyContent:'space-between', marginBottom:12 }}>
                          <div style={{ color:'#D4AF37' }}>{chapters.length} Section(s)</div>
                          <div style={{ color:'#999' }}>{ chapters.reduce((a,c)=>a+c.wordCount,0).toLocaleString() } words</div>
                        </div>
                        <div style={{ maxHeight:300, overflowY:'auto', display:'grid', gap:8 }}>
                          { chapters.map(ch => (
                            <div key={ch.id} style={{ padding:10, borderRadius:8, background:'rgba(255,255,255,0.02)', border:'1px solid rgba(255,255,255,0.02)' }}>
                              <div style={{ display:'flex', justifyContent:'space-between' }}>
                                <div style={{ fontWeight:700 }}>{ch.title}</div>
                                <div style={{ color:'#999' }}>{ ch.wordCount.toLocaleString() } words</div>
                              </div>
                              <div style={{ marginTop:8, color:'#ccc', fontSize:13, maxHeight:60, overflow:'hidden', whiteSpace:'pre-wrap' }}>{ ch.content.slice(0,240) }{ ch.content.length>240 ? '...' : '' }</div>
                            </div>
                          )) }
                        </div>
                      </>
                    ) : (
                      <div style={{ textAlign:'center', padding:28, color:'#888' }}>
                        <div style={{ fontSize:40 }}>üìë</div>
                        <div style={{ marginTop:8 }}>Upload a manuscript to see structure</div>
                      </div>
                    ) }
                  </div>

                  <div className="card" style={{ marginTop:12 }}>
                    <h3 style={{ color:'#D4AF37' }}>Presets</h3>
                    <div style={{ display:'flex', gap:8, flexWrap:'wrap', marginTop:10 }}>
                      { presets.map(p => <button key={p.id} onClick={()=>setPreset(p)} style={primaryBtnStyle}>{p.name}</button>) }
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* TEMPLATES TAB */}
            { activeTab === 'template' && (
              <div className="card">
                <h3 style={{ color:'#D4AF37' }}>Select Template</h3>
                <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))', gap:12, marginTop:12 }}>
                  { templates.map(t => (
                    <div key={t.id} onClick={()=> { /* setSelectedTemplate... */ showNotification(`‚úì ${t.name} selected`) }} style={{ padding:12, borderRadius:8, background:'rgba(255,255,255,0.02)', cursor:'pointer' }}>
                      <div style={{ width:40, height:58, background: t.gradient, borderRadius:6, marginBottom:8 }} />
                      <div style={{ color:'#E8E8E8', fontWeight:700 }}>{t.name}</div>
                      <div style={{ color:'#888', marginTop:6 }}>{t.desc}</div>
                    </div>
                  )) }
                </div>
              </div>
            )}

            {/* PREVIEW TAB */}
            { activeTab === 'preview' && (
              <div>
                <div style={{ display:'flex', justifyContent:'center', marginBottom:18 }}>
                  <div style={{ display:'flex', gap:6, background:'rgba(12,12,18,0.7)', padding:6, borderRadius:8 }}>
                    { [{id:'cover',label:'Cover'},{id:'interior',label:'Interior'},{id:'fullbook',label:'Full Book'}].map(m=>(
                      <button key={m.id} onClick={()=>setPreviewMode(m.id)} style={{ padding:'8px 12px', borderRadius:6, border:'none', background: previewMode===m.id ? 'linear-gradient(135deg,#D4AF37,#AA8C2C)' : 'transparent', color: previewMode===m.id ? '#111' : '#aaa' }}>{m.label}</button>
                    )) }
                  </div>
                </div>

                { previewMode === 'cover' && <div style={{ display:'flex', justifyContent:'center' }}><BookCover size="large" /></div> }
                { previewMode === 'interior' && (
                  <div style={{ display:'flex', justifyContent:'center' }}>
                    <div style={{ maxWidth:560, background:'#FAF8F5', padding:28, borderRadius:8, color:'#222', fontFamily:'Georgia, serif' }}>
                      <div style={{ textAlign:'center', color:'#888', marginBottom:18 }}>12</div>
                      <p style={{ fontSize:14, lineHeight:1.8, textAlign:'justify' }}>
                        <span style={{ float:'left', fontSize:44, color:'#D4AF37', paddingRight:8, fontFamily:"'Playfair Display',Georgia,serif" }}>T</span>
                        The morning light filtered through the ancient windows, casting long shadows across the weathered floorboards. She stood there, breath held, knowing that the next few moments would change everything.
                      </p>
                      <p style={{ marginTop:12, fontSize:14 }}>Years of searching had led to this single moment. A lifetime of questions waiting to be answered.</p>
                      <div style={{ textAlign:'center', marginTop:28, color:'#D4AF37' }}>‚ùß</div>
                    </div>
                  </div>
                ) }
                { previewMode === 'fullbook' && (
                  <div style={{ display:'flex', justifyContent:'center', gap:20 }}>
                    <div style={{ textAlign:'center' }}><p style={{ color:'#888', fontSize:12 }}>Cover</p><BookCover size="small" /></div>
                    <div>
                      <p style={{ color:'#888', fontSize:12 }}>Interior</p>
                      <div style={{ display:'flex', boxShadow:'0 12px 35px rgba(0,0,0,0.45)', borderRadius:6, overflow:'hidden' }}>
                        <div style={{ width:140, height:200, background:'#FAF8F5', padding:12, borderRight:'1px solid #e5e0d8' }}>
                          <p style={{ fontSize:8, color:'#888', textAlign:'center' }}>12</p>
                          <p style={{ fontSize:9, color:'#2A2A2A' }}><strong>T</strong>he morning light filtered through. She stood there, breath held.</p>
                        </div>
                        <div style={{ width:140, height:200, background:'#FAF8F5', padding:12 }}>
                          <p style={{ fontSize:9, color:'#2A2A2A' }}>Years of searching had led to this moment.</p>
                          <div style={{ textAlign:'center', marginTop:18, color:'#D4AF37' }}>‚ùß</div>
                          <p style={{ fontSize:7, color:'#888', textAlign:'center', marginTop:24 }}>13</p>
                        </div>
                      </div>
                    </div>
                  </div>
                ) }
              </div>
            )}

            {/* EXPORT TAB */}
            { activeTab === 'export' && (
              <div>
                <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit,minmax(220px,1fr))', gap:12 }}>
                  <div className="card" style={{ textAlign:'center' }}>
                    <div style={{ fontSize:36 }}>üìÑ</div>
                    <h3 style={{ color:'#D4AF37' }}>PDF Format</h3>
                    <p style={{ color:'#999' }}>Print-ready with cover, title page & content</p>
                    <button onClick={exportPDF} style={{ marginTop:12, ...primaryBtnStyle }}>‚¨á Download PDF</button>
                  </div>

                  <div className="card" style={{ textAlign:'center' }}>
                    <div style={{ fontSize:36 }}>üìö</div>
                    <h3 style={{ color:'#D4AF37' }}>EPUB Format</h3>
                    <p style={{ color:'#999' }}>For Kindle, Apple Books, Kobo</p>
                    <button onClick={exportEPUB} style={{ marginTop:12, ...primaryBtnStyle }}>‚¨á Download EPUB</button>
                  </div>

                  <div className="card" style={{ textAlign:'center' }}>
                    <div style={{ fontSize:36 }}>üñºÔ∏è</div>
                    <h3 style={{ color:'#D4AF37' }}>Cover Image</h3>
                    <p style={{ color:'#999' }}>High-res cover for publishing platforms</p>
                    <button onClick={downloadCoverImage} disabled={!getCurrentCoverImage()} style={{ marginTop:12, ...(getCurrentCoverImage() ? primaryBtnStyle : { ...secondaryBtnStyle, cursor:'not-allowed', opacity:0.6 }) }}>{ getCurrentCoverImage() ? '‚¨á Download Cover' : 'No Cover' }</button>
                  </div>

                  <div className="card" style={{ textAlign:'center' }}>
                    <div style={{ fontSize:36 }}>üìù</div>
                    <h3 style={{ color:'#D4AF37' }}>Plain Text</h3>
                    <p style={{ color:'#999' }}>Simple text file for editing or backup</p>
                    <button onClick={exportTXT} style={{ marginTop:12, ...secondaryBtnStyle }}>‚¨á Download TXT</button>
                  </div>
                </div>

                <div style={{ marginTop:18, padding:12, background:'rgba(212,175,55,0.04)', borderRadius:8 }}>
                  <h4 style={{ color:'#D4AF37' }}>üí° Tips</h4>
                  <ul style={{ color:'#bbb', marginTop:8 }}>
                    <li>Fill Title & Author for proper metadata</li>
                    <li>Upload a cover image or generate with AI</li>
                    <li>Upload your manuscript to include your content</li>
                    <li>Files download to your device's Downloads folder</li>
                  </ul>
                </div>
              </div>
            )}

          </main>

          <footer style={{ textAlign:'center', padding:20, borderTop:'1px solid rgba(212,175,55,0.04)', color:'#303030' }}>
            <small>Premium Ebook Studio ‚Ä¢ Real Export</small>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PremiumEbookStudio />);

  </script>
</body>
</html>
